name: Frontend CI - Build & Test

on:
  workflow_dispatch:
  pull_request:
    branches: [ dev ]
    paths:
      - "src/**"
      - "public/**"
      - "package*.json"

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    environment:
      name: development
    env:
      AWS_DEV_ACCOUNT: ${{ secrets.AWS_DEV_ACCOUNT }}
      node_version: "22.1.0"
      
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Checkout Common Action
        uses: actions/checkout@v4
        with:
          repository: Innovate-Future-Foundation/common-action
          path: common-action

      - name: Setup Frontend Environment
        uses: ./common-action/setup-frontend-aws
        with:
          node_version: ${{ env.node_version }}
          aws_region: "ap-southeast-2"
          role_arn: "arn:aws:iam::${{ secrets.AWS_DEV_ACCOUNT }}:role/oidc-if-Frontend"
          api_url: "https://dev.innovatefuture.foundation"

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        run: npm test

      - name: Build Production Assets
        run: npm run build

      - name: Verify Build Output
        run: |
          if [ ! -f dist/index.html ]; then
            echo "Build verification failed!"
            exit 1
          fi

      - name: Upload Production Assets
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-${{ github.run_number }}
          path: dist/
          retention-days: 1

      - name: Notify Discord on Failure
        if: failure()
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DEV_PR_DISCORD_WEBHOOK }}
          thread-id: "1330422313769893938"
          username: "Frontend Build Bot"
          content: |
            ‚ùå Frontend Build Failed!
            **Pipeline:** Build & Test
            **Build:** ${{ github.run_number }}
            **Branch:** ${{ github.ref_name }}
            **Triggered by:** ${{ github.actor }}
            <@&1315850473391001674> 